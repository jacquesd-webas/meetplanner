name: Adventure Meets CI/CD Pipeline

on:
  push:
    branches:
      - release/*
    tags:
      - "*"

env:
  DOCKER_IMAGES: api db_migrate web
  WEB_ARCHiVES: web

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      is_release_tag: ${{ steps.set-version.outputs.is_release_tag }}
    steps:
      - name: Determine version
        id: set-version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME}"
          VERSION="${VERSION#v}"
          VERSION="${VERSION#release/}"
          if [ -z "$VERSION" ]; then
            VERSION="latest"
          fi

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            IS_RELEASE_TAG=true
          else
            IS_RELEASE_TAG=false
          fi

          echo "$VERSION" > build_version.txt
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "is_release_tag=$IS_RELEASE_TAG" >> "$GITHUB_OUTPUT"

      - name: Upload build version artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-version
          path: build_version.txt

  build-docker:
    runs-on: ubuntu-latest
    needs: metadata
    if: ${{ needs.metadata.outputs.is_release_tag == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore buildx cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-
          retention-days: 1

      - name: Build images via ci/01_build_docker.sh
        env:
          COMPOSE_DOCKER_CLI_BUILD: 1
          DOCKER_BUILDKIT: 1
          BUILDX_CACHE_FROM: type=local,src=/tmp/.buildx-cache
          BUILDX_CACHE_TO: type=local,dest=/tmp/.buildx-cache-new,mode=max
        run: |
          mkdir -p /tmp/.buildx-cache /tmp/.buildx-cache-new
          ci/01_build_docker.sh ${{ env.DOCKER_IMAGES }}
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  build-web:
    runs-on: ubuntu-latest
    needs: metadata
    if: ${{ needs.metadata.outputs.is_release_tag == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Enable pnpm
        run: corepack enable

      - name: Determine pnpm store directory
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-build-${{ runner.os }}-${{ hashFiles('web/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-build-${{ runner.os }}-
          retention-days: 1

      - name: Build web via ci/01_build_web.sh
        env:
          VERSION: ${{ needs.metadata.outputs.version }}
        run: |
          ci/01_build_web.sh web

      - name: Cache web build output
        uses: actions/cache@v4
        with:
          path: dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-
          retention-days: 1

  tests:
    runs-on: ubuntu-latest
    needs: metadata
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore buildx cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-
          retention-days: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable pnpm
        run: corepack enable

      - name: Determine pnpm store directory
        id: pnpm-cache
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: pnpm-store-tests-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-tests-${{ runner.os }}-
          retention-days: 1

      - name: Install API dependencies
        working-directory: api
        run: pnpm install --frozen-lockfile

      - name: Build API
        working-directory: api
        run: pnpm run build

      - name: Build web via ci/01_build_web.sh
        env:
          VERSION: ${{ needs.metadata.outputs.version }}
        run: |
          ci/01_build_web.sh web

  publish-docker:
    runs-on: ubuntu-latest
    needs: [metadata, build-docker, tests]
    if: ${{ needs.metadata.outputs.is_release_tag == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Restore buildx cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            buildx-${{ runner.os }}-
          retention-days: 1

      - name: Login to registry
        run: echo ${{ secrets.CI_REGISTRY_PAT }} | docker login ${{ vars.CI_REGISTRY_HOST }} -u ${{ vars.CI_REGISTRY_USER }} --password-stdin

      - name: Build and push api image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          push: true
          tags: |
            ${{ vars.CI_REGISTRY_HOST }}/fringecoding/adventuremeets_api:${{ needs.metadata.outputs.version }}
            ${{ vars.CI_REGISTRY_HOST }}/fringecoding/adventuremeets_api:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Build and push backup_runner image
        uses: docker/build-push-action@v5
        with:
          context: ./backup_runner
          push: true
          tags: |
            ${{ vars.CI_REGISTRY_HOST }}/fringecoding/adventuremeets_backup_runner:${{ needs.metadata.outputs.version }}
            ${{ vars.CI_REGISTRY_HOST }}/fringecoding/adventuremeets_backup_runner:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Persist buildx cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  publish-web:
    runs-on: ubuntu-latest
    needs: [metadata, build-web, tests]
    if: ${{ needs.metadata.outputs.is_release_tag == 'true' }}
    env:
      WEB_STAGE_DIR: staging
      WEB_HOST: webapps1.fringecoding.com
      WEB_USER: webdeploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore web build cache
        uses: actions/cache@v4
        with:
          path: dist
          key: web-build-${{ github.sha }}
          restore-keys: |
            web-build-
          retention-days: 1

      - name: Prepare web bundle
        run: |
          FILE=$(ls dist/*.tgz | head -n 1)
          if [ -z "$FILE" ]; then
            echo "No cached web bundle found in dist/"
            exit 1
          fi
          cp "$FILE" web-build.tar.gz

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Upload web bundle to staging
        run: |
          cp web-artifacts/web-build.tar.gz .
          WEB_STAGE_DIR=${WEB_STAGE_DIR} WEB_HOST=${WEB_HOST} WEB_USER=${WEB_USER} \
            sh ./ci/04_publish_web.sh ${{ needs.metadata.outputs.version }}
